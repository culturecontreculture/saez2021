# ğŸµ Apocalypse - SystÃ¨me de choix de format CD/Vinyle

Projet Next.js permettant aux clients ayant achetÃ© des packs MÃ©lancolie ou Symphonie de choisir leur format de livraison (CD ou Vinyle).

**URL de production :** `https://saez2021.culturecontreculture.fr`

---

## ğŸš€ DÃ©ploiement rapide

### 1ï¸âƒ£ CrÃ©er le repository GitHub

```bash
# Sur GitHub, crÃ©e un nouveau repository vide (sans README)
# Exemple : https://github.com/ton-user/apocalypse-format
```

### 2ï¸âƒ£ Initialiser et pousser le code

```bash
# Dans le dossier du projet
git init
git add .
git commit -m "Initial commit - SystÃ¨me choix format CD/Vinyle"
git branch -M main
git remote add origin https://github.com/ton-user/apocalypse-format.git
git push -u origin main
```

### 3ï¸âƒ£ DÃ©ployer sur Vercel

**Option A : Via le dashboard Vercel (recommandÃ©)**

1. Va sur [vercel.com](https://vercel.com)
2. Clique sur **"Add New..."** â†’ **"Project"**
3. Importe ton repository GitHub
4. Vercel dÃ©tecte automatiquement Next.js
5. **Avant de dÃ©ployer**, ajoute les variables d'environnement :

```
NEXT_PUBLIC_SUPABASE_URL = https://cciypmugbemibaeuppco.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjaXlwbXVnYmVtaWJhZXVwcGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY1NzE3NjEsImV4cCI6MjA0MjE0Nzc2MX0.Jz6v2Akm17_xtPw14w6RaaPV4oQ-dEGpqJhJxEd2BCo
SUPABASE_SERVICE_ROLE_KEY = [ta_service_role_key_depuis_supabase]
BREVO_API_KEY = votre_cle_brevo_ici
NEXT_PUBLIC_BASE_URL = https://saez2021.culturecontreculture.fr
```

6. Clique sur **"Deploy"**
7. Attends 2-3 minutes â±ï¸

**Option B : Via CLI**

```bash
npm i -g vercel
vercel login
vercel --prod
# Suis les instructions et ajoute les variables d'environnement quand demandÃ©
```

### 4ï¸âƒ£ Configurer le sous-domaine

Dans Vercel :
1. Va dans **Settings** â†’ **Domains**
2. Ajoute : `saez2021.culturecontreculture.fr`
3. Vercel te donnera un enregistrement DNS Ã  ajouter chez ton registrar :
   ```
   Type: CNAME
   Name: saez2021
   Value: cname.vercel-dns.com
   ```
4. Ajoute cet enregistrement dans la config DNS de `culturecontreculture.fr`
5. Attends la propagation (quelques minutes)

---

## ğŸ”‘ Variables d'environnement

### OÃ¹ trouver `SUPABASE_SERVICE_ROLE_KEY` ?

1. Va sur [supabase.com](https://supabase.com)
2. SÃ©lectionne ton projet
3. **Settings** â†’ **API**
4. Copie la clÃ© `service_role` (âš ï¸ garde-la secrÃ¨te)

### Variables Ã  configurer dans Vercel

| Variable | Valeur | Environnement |
|----------|--------|---------------|
| `NEXT_PUBLIC_SUPABASE_URL` | `https://cciypmugbemibaeuppco.supabase.co` | Production, Preview, Development |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1...` | Production, Preview, Development |
| `SUPABASE_SERVICE_ROLE_KEY` | Ta clÃ© service_role | Production, Preview, Development |
| `BREVO_API_KEY` | `xkeysib-d3645d01...` | Production, Preview, Development |
| `NEXT_PUBLIC_BASE_URL` | `https://saez2021.culturecontreculture.fr` | Production |

---

## ğŸ—„ï¸ Migration SQL

**âš ï¸ Ã€ exÃ©cuter une seule fois dans Supabase SQL Editor :**

```sql
-- Table pour stocker les choix de format
CREATE TABLE IF NOT EXISTS public.format_choices (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  customer_id bigint NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  pack_type text NOT NULL CHECK (pack_type IN ('melancolie', 'symphonie')),
  format text NOT NULL CHECK (format IN ('cd', 'vinyle')),
  quantite smallint NOT NULL CHECK (quantite > 0),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_format_choices_customer ON format_choices(customer_id);

-- Table pour les magic links
CREATE TABLE IF NOT EXISTS public.magic_links (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id bigint NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  token text UNIQUE NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  used boolean DEFAULT false
);

CREATE INDEX IF NOT EXISTS idx_magic_links_token ON magic_links(token);
CREATE INDEX IF NOT EXISTS idx_magic_links_expires ON magic_links(expires_at);

-- Colonnes de tracking
ALTER TABLE public.customers 
ADD COLUMN IF NOT EXISTS format_choice_completed boolean DEFAULT false,
ADD COLUMN IF NOT EXISTS format_choice_date timestamp with time zone NULL;
```

---

## ğŸ§ª Tester le systÃ¨me

### Workflow complet

1. **Page de login** : `https://saez2021.culturecontreculture.fr/format-login`
2. Entre un email de test (qui existe dans `customers` avec `melancolie > 0` ou `symphonie > 0`)
3. VÃ©rifie la rÃ©ception de l'email
4. Clique sur le lien dans l'email
5. Arrive sur `/format-choice?token=xxx`
6. RÃ©partis les packs entre CD et Vinyle
7. Valide
8. ReÃ§ois l'email de confirmation
9. VÃ©rifie dans Supabase que les donnÃ©es sont bien enregistrÃ©es

### RequÃªtes SQL utiles

**Voir tous les choix effectuÃ©s :**
```sql
SELECT 
  c.email,
  c.prenom,
  c.nom,
  fc.pack_type,
  fc.format,
  fc.quantite,
  c.format_choice_date
FROM customers c
LEFT JOIN format_choices fc ON c.id = fc.customer_id
WHERE c.melancolie > 0 OR c.symphonie > 0
ORDER BY c.format_choice_date DESC;
```

**Clients qui n'ont pas encore choisi :**
```sql
SELECT email, prenom, nom, melancolie, symphonie
FROM customers
WHERE (melancolie > 0 OR symphonie > 0)
AND (format_choice_completed = false OR format_choice_completed IS NULL);
```

**Statistiques des formats :**
```sql
SELECT 
  pack_type,
  format,
  SUM(quantite) as total
FROM format_choices
GROUP BY pack_type, format
ORDER BY pack_type, format;
```

---

## ğŸ’» DÃ©veloppement local

```bash
# Installer les dÃ©pendances
npm install

# Copier les variables d'environnement
cp .env.local.example .env.local
# Ã‰dite .env.local et ajoute ta SUPABASE_SERVICE_ROLE_KEY

# Lancer le serveur de dev
npm run dev

# Ouvrir http://localhost:3000
```

---

## ğŸ“§ Emails envoyÃ©s

### Email 1 : Magic link
- **ExpÃ©diteur** : support@culturecontreculture.fr
- **Sujet** : "Apocalypse - Choisissez le format de vos packs"
- **Contenu** : Lien magique valable 24h

### Email 2 : Confirmation
- **ExpÃ©diteur** : support@culturecontreculture.fr
- **Sujet** : "Apocalypse - Confirmation de votre choix de format"
- **Contenu** : RÃ©capitulatif des choix (ex: 2 CD MÃ©lancolie, 4 Vinyle MÃ©lancolie)

---

## ğŸ“ Structure du projet

```
apocalypse-format-project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ format-login/
â”‚   â”‚   â””â”€â”€ page.js              # Page de connexion
â”‚   â”œâ”€â”€ format-choice/
â”‚   â”‚   â””â”€â”€ page.js              # Page de choix du format
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ send-magic-link/
â”‚   â”‚   â”‚   â””â”€â”€ route.js         # API d'envoi du lien
â”‚   â”‚   â”œâ”€â”€ validate-token/
â”‚   â”‚   â”‚   â””â”€â”€ route.js         # API de validation
â”‚   â”‚   â””â”€â”€ save-format/
â”‚   â”‚       â””â”€â”€ route.js         # API de sauvegarde
â”‚   â”œâ”€â”€ layout.js
â”‚   â”œâ”€â”€ page.js                  # Redirect vers /format-login
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ supabaseClient.js
â”œâ”€â”€ package.json
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tailwind.config.js
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ .env.local.example
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## âœ… Checklist avant production

- [ ] Migration SQL exÃ©cutÃ©e dans Supabase
- [ ] Repository GitHub crÃ©Ã© et code poussÃ©
- [ ] Projet dÃ©ployÃ© sur Vercel
- [ ] Variables d'environnement configurÃ©es
- [ ] Sous-domaine `saez2021.culturecontreculture.fr` configurÃ©
- [ ] Test avec un email rÃ©el de la base
- [ ] VÃ©rification de la rÃ©ception des emails
- [ ] VÃ©rification des donnÃ©es dans Supabase

---

## ğŸ†˜ Support

Pour toute question :
- Email support clients : **support@culturecontreculture.fr**
- ProblÃ¨me technique : voir les logs dans Vercel â†’ Functions

---

## ğŸ“ Notes

- Les tokens de magic link expirent aprÃ¨s **24 heures**
- Les clients peuvent redemander un lien et **modifier leur choix**
- La rÃ©partition doit correspondre **exactement** au nombre total de packs
- Exemple : 6 packs MÃ©lancolie â†’ 2 CD + 4 Vinyle = 6 âœ…

---

**ğŸ¸ Bon dÃ©ploiement !**
