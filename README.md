# 🎵 Apocalypse - Système de choix de format CD/Vinyle

Projet Next.js permettant aux clients ayant acheté des packs Mélancolie ou Symphonie de choisir leur format de livraison (CD ou Vinyle).

**URL de production :** `https://saez2021.culturecontreculture.fr`

---

## 🚀 Déploiement rapide

### 1️⃣ Créer le repository GitHub

```bash
# Sur GitHub, crée un nouveau repository vide (sans README)
# Exemple : https://github.com/ton-user/apocalypse-format
```

### 2️⃣ Initialiser et pousser le code

```bash
# Dans le dossier du projet
git init
git add .
git commit -m "Initial commit - Système choix format CD/Vinyle"
git branch -M main
git remote add origin https://github.com/ton-user/apocalypse-format.git
git push -u origin main
```

### 3️⃣ Déployer sur Vercel

**Option A : Via le dashboard Vercel (recommandé)**

1. Va sur [vercel.com](https://vercel.com)
2. Clique sur **"Add New..."** → **"Project"**
3. Importe ton repository GitHub
4. Vercel détecte automatiquement Next.js
5. **Avant de déployer**, ajoute les variables d'environnement :

```
NEXT_PUBLIC_SUPABASE_URL = https://cciypmugbemibaeuppco.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjaXlwbXVnYmVtaWJhZXVwcGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY1NzE3NjEsImV4cCI6MjA0MjE0Nzc2MX0.Jz6v2Akm17_xtPw14w6RaaPV4oQ-dEGpqJhJxEd2BCo
SUPABASE_SERVICE_ROLE_KEY = [ta_service_role_key_depuis_supabase]
BREVO_API_KEY = votre_cle_brevo_ici
NEXT_PUBLIC_BASE_URL = https://saez2021.culturecontreculture.fr
```

6. Clique sur **"Deploy"**
7. Attends 2-3 minutes ⏱️

**Option B : Via CLI**

```bash
npm i -g vercel
vercel login
vercel --prod
# Suis les instructions et ajoute les variables d'environnement quand demandé
```

### 4️⃣ Configurer le sous-domaine

Dans Vercel :
1. Va dans **Settings** → **Domains**
2. Ajoute : `saez2021.culturecontreculture.fr`
3. Vercel te donnera un enregistrement DNS à ajouter chez ton registrar :
   ```
   Type: CNAME
   Name: saez2021
   Value: cname.vercel-dns.com
   ```
4. Ajoute cet enregistrement dans la config DNS de `culturecontreculture.fr`
5. Attends la propagation (quelques minutes)

---

## 🔑 Variables d'environnement

### Où trouver `SUPABASE_SERVICE_ROLE_KEY` ?

1. Va sur [supabase.com](https://supabase.com)
2. Sélectionne ton projet
3. **Settings** → **API**
4. Copie la clé `service_role` (⚠️ garde-la secrète)

### Variables à configurer dans Vercel

| Variable | Valeur | Environnement |
|----------|--------|---------------|
| `NEXT_PUBLIC_SUPABASE_URL` | `https://cciypmugbemibaeuppco.supabase.co` | Production, Preview, Development |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1...` | Production, Preview, Development |
| `SUPABASE_SERVICE_ROLE_KEY` | Ta clé service_role | Production, Preview, Development |
| `BREVO_API_KEY` | `xkeysib-d3645d01...` | Production, Preview, Development |
| `NEXT_PUBLIC_BASE_URL` | `https://saez2021.culturecontreculture.fr` | Production |

---

## 🗄️ Migration SQL

**⚠️ À exécuter une seule fois dans Supabase SQL Editor :**

```sql
-- Table pour stocker les choix de format
CREATE TABLE IF NOT EXISTS public.format_choices (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  customer_id bigint NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  pack_type text NOT NULL CHECK (pack_type IN ('melancolie', 'symphonie')),
  format text NOT NULL CHECK (format IN ('cd', 'vinyle')),
  quantite smallint NOT NULL CHECK (quantite > 0),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_format_choices_customer ON format_choices(customer_id);

-- Table pour les magic links
CREATE TABLE IF NOT EXISTS public.magic_links (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id bigint NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  token text UNIQUE NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  used boolean DEFAULT false
);

CREATE INDEX IF NOT EXISTS idx_magic_links_token ON magic_links(token);
CREATE INDEX IF NOT EXISTS idx_magic_links_expires ON magic_links(expires_at);

-- Colonnes de tracking
ALTER TABLE public.customers 
ADD COLUMN IF NOT EXISTS format_choice_completed boolean DEFAULT false,
ADD COLUMN IF NOT EXISTS format_choice_date timestamp with time zone NULL;
```

---

## 🧪 Tester le système

### Workflow complet

1. **Page de login** : `https://saez2021.culturecontreculture.fr/format-login`
2. Entre un email de test (qui existe dans `customers` avec `melancolie > 0` ou `symphonie > 0`)
3. Vérifie la réception de l'email
4. Clique sur le lien dans l'email
5. Arrive sur `/format-choice?token=xxx`
6. Répartis les packs entre CD et Vinyle
7. Valide
8. Reçois l'email de confirmation
9. Vérifie dans Supabase que les données sont bien enregistrées

### Requêtes SQL utiles

**Voir tous les choix effectués :**
```sql
SELECT 
  c.email,
  c.prenom,
  c.nom,
  fc.pack_type,
  fc.format,
  fc.quantite,
  c.format_choice_date
FROM customers c
LEFT JOIN format_choices fc ON c.id = fc.customer_id
WHERE c.melancolie > 0 OR c.symphonie > 0
ORDER BY c.format_choice_date DESC;
```

**Clients qui n'ont pas encore choisi :**
```sql
SELECT email, prenom, nom, melancolie, symphonie
FROM customers
WHERE (melancolie > 0 OR symphonie > 0)
AND (format_choice_completed = false OR format_choice_completed IS NULL);
```

**Statistiques des formats :**
```sql
SELECT 
  pack_type,
  format,
  SUM(quantite) as total
FROM format_choices
GROUP BY pack_type, format
ORDER BY pack_type, format;
```

---

## 💻 Développement local

```bash
# Installer les dépendances
npm install

# Copier les variables d'environnement
cp .env.local.example .env.local
# Édite .env.local et ajoute ta SUPABASE_SERVICE_ROLE_KEY

# Lancer le serveur de dev
npm run dev

# Ouvrir http://localhost:3000
```

---

## 📧 Emails envoyés

### Email 1 : Magic link
- **Expéditeur** : support@culturecontreculture.fr
- **Sujet** : "Apocalypse - Choisissez le format de vos packs"
- **Contenu** : Lien magique valable 24h

### Email 2 : Confirmation
- **Expéditeur** : support@culturecontreculture.fr
- **Sujet** : "Apocalypse - Confirmation de votre choix de format"
- **Contenu** : Récapitulatif des choix (ex: 2 CD Mélancolie, 4 Vinyle Mélancolie)

---

## 📁 Structure du projet

```
apocalypse-format-project/
├── app/
│   ├── format-login/
│   │   └── page.js              # Page de connexion
│   ├── format-choice/
│   │   └── page.js              # Page de choix du format
│   ├── api/
│   │   ├── send-magic-link/
│   │   │   └── route.js         # API d'envoi du lien
│   │   ├── validate-token/
│   │   │   └── route.js         # API de validation
│   │   └── save-format/
│   │       └── route.js         # API de sauvegarde
│   ├── layout.js
│   ├── page.js                  # Redirect vers /format-login
│   └── globals.css
├── supabaseClient.js
├── package.json
├── next.config.js
├── tailwind.config.js
├── postcss.config.js
├── .env.local.example
├── .gitignore
└── README.md
```

---

## ✅ Checklist avant production

- [ ] Migration SQL exécutée dans Supabase
- [ ] Repository GitHub créé et code poussé
- [ ] Projet déployé sur Vercel
- [ ] Variables d'environnement configurées
- [ ] Sous-domaine `saez2021.culturecontreculture.fr` configuré
- [ ] Test avec un email réel de la base
- [ ] Vérification de la réception des emails
- [ ] Vérification des données dans Supabase

---

## 🆘 Support

Pour toute question :
- Email support clients : **support@culturecontreculture.fr**
- Problème technique : voir les logs dans Vercel → Functions

---

## 📝 Notes

- Les tokens de magic link expirent après **24 heures**
- Les clients peuvent redemander un lien et **modifier leur choix**
- La répartition doit correspondre **exactement** au nombre total de packs
- Exemple : 6 packs Mélancolie → 2 CD + 4 Vinyle = 6 ✅

---

**🎸 Bon déploiement !**
